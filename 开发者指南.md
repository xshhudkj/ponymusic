# 开发者指南

## 项目概述
这是一个基于Android Automotive平台的音乐播放应用，采用MVVM架构模式，支持网易云音乐API。应用针对车载环境进行了全面优化，包括全屏沉浸式体验、现代化交互动画和渐进式加载等特性。

## 技术栈
- **架构模式**: MVVM (Model-View-ViewModel)
- **依赖注入**: Hilt
- **网络请求**: Retrofit + OkHttp
- **数据库**: Room
- **播放器**: Media3 + ExoPlayer
- **图片加载**: Glide
- **路由框架**: CRouter
- **歌词显示**: LrcView
- **动画框架**: 自定义动画工具类 + Material Design Components

## 开发环境要求
- Android Studio 2023.1.1+
- JDK 17+
- Android SDK 34+
- Gradle 8.7+

## 最新优化特性

### 1. 全屏沉浸式体验
- 所有Activity和Fragment都隐藏系统状态栏和导航栏
- 使用`AppTheme.CarImmersive`主题确保一致的全屏体验
- 特殊处理了`MusicFragmentContainerActivity`和`AboutActivity`的全屏模式

### 2. 渐进式加载优化（重点优化）
- **分批加载API**: 新增`DiscoverApi.getPlaylistSongListBatch()`方法
- **动态播放列表**: 实现`PlayerController.appendToPlaylist()`方法
- **智能分批管理器**: 新增`BatchPlaylistLoader`类，提供智能分批加载策略
- **智能播放策略**:
  - **前3首歌曲**: 快速加载前3首，立即播放用户选择的歌曲
  - **4-20首歌曲**: 加载前20首，确保用户点击的歌曲立即可播放
  - **20首以后**: 按50首为单位加载到目标位置，避免过度加载
  - **后台加载**: 分批次（每批20首）异步加载剩余歌曲，延时200ms避免卡顿
- **智能等待机制**: `playWhenAvailable()`方法支持等待歌曲加载完成后播放

### 3. 播放页面滑动动画（重点优化）
- **专用主题**: `AppTheme.CarImmersive.Playing`配置播放页面动画
- **动画资源**:
  - 进入动画：`anim_slide_up_with_background.xml`
  - 退出动画：`anim_slide_down_with_background.xml`
- **统一跳转**: 所有播放歌曲的地方都自动弹出PlayingActivity
- **优化退出动画**:
  - 添加400ms延时确保下滑动画完整播放
  - 重写`finish()`方法手动应用退出动画
  - 使用`overridePendingTransition()`确保在主题消失前执行动画

### 4. 现代化交互动画
- **动画工具类**: `AnimationUtils`提供车载环境优化的交互动画
- **扩展函数**: `ViewExt`提供便捷的动画方法
- **动画类型**:
  - 按钮动画：缩放 + 涟漪效果
  - 播放控制动画：较大缩放适合车载操作
  - 列表项动画：轻微缩放提升交互体验

### 5. 播放器缓存进度可视化
- **自定义组件**: `BufferedCircularProgressIndicator`支持双层进度显示
- **实时缓存监听**: ExoPlayer缓存进度实时更新
- **进度层次**:
  - 背景进度（灰色）
  - 缓存进度（半透明白色）
  - 播放进度（主题色）

## 核心模块说明

### 播放器模块 (PlayerController)
- **接口**: `PlayerController` - 定义播放器核心功能
- **实现**: `PlayerControllerImpl` - 基于ExoPlayer的具体实现
- **新增功能**: 
  - `appendToPlaylist()` - 动态添加歌曲到播放列表
  - 实时缓存进度监听和更新

### 网络模块 (DiscoverApi)
- **分批加载**: `getPlaylistSongListBatch()` - 支持分页获取歌单歌曲
- **完整加载**: `getFullPlaylistSongList()` - 获取完整歌单（保持兼容性）

### 动画模块
- **工具类**: `AnimationUtils` - 提供各种动画效果
- **扩展函数**: `ViewExt` - 简化动画使用
- **自定义组件**: `BufferedCircularProgressIndicator` - 缓存进度可视化

## API依赖说明
项目严格按照`api.txt`中定义的接口进行API调用，主要依赖：
- `/playlist/detail` - 获取歌单详情
- `/playlist/track/all` - 获取歌单歌曲列表（支持分页）
- `/song/url` - 获取歌曲播放链接
- `/search` - 搜索功能
- `/recommend/songs` - 每日推荐

## 开发规范
1. **MVVM架构**: 严格遵循Model-View-ViewModel模式
2. **全屏适配**: 所有新页面必须支持全屏沉浸式
3. **动画一致性**: 使用统一的动画工具类和扩展函数
4. **车载优化**: 考虑大屏幕和触摸操作的特殊需求
5. **渐进式加载**: 优先考虑用户体验，避免长时间等待

## 编译和运行
```bash
# 编译Debug版本
./gradlew assembleDebug --console=plain --no-daemon

# 安装到设备
./gradlew installDebug
```

## 注意事项
- 确保API域名配置正确（参考`api.txt`）
- 车载环境下测试所有交互动画
- 验证全屏模式在不同设备上的表现
- 测试渐进式加载在网络较慢时的体验
